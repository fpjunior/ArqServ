<!-- DiÃ¡logo Novo MunicÃ­pio usando MunicipalityDialogComponent -->
<div *ngIf="showTailwindDialog" class="fixed inset-0 bg-black bg-opacity-60 z-[9999] flex items-center justify-center">
  <app-municipality-dialog (municipalityCreated)="onMunicipalityCreated($event)"
    (cancelled)="onMunicipalityDialogCancelled()">
  </app-municipality-dialog>
</div>

<!-- DiÃ¡logo Novo Servidor usando ServerDialogComponent -->
<div *ngIf="showServerDialog" class="fixed inset-0 bg-black bg-opacity-60 z-[9999] flex items-center justify-center">
  <app-server-dialog [data]="{ municipalityCode: selectedMunicipalityCode, municipalityName: selectedMunicipalityName }"
    (serverCreated)="onServerCreated($event)" (cancelled)="onServerDialogCancelled()">
  </app-server-dialog>
</div>

<!-- DiÃ¡logo Novo Tipo Financeiro -->
<div *ngIf="showFinancialTypeDialog"
  class="fixed inset-0 bg-black bg-opacity-60 z-[9999] flex items-center justify-center">
  <app-financial-type-dialog (typeCreated)="onFinancialTypeCreated($event)"
    (cancelled)="onFinancialTypeDialogCancelled()">
  </app-financial-type-dialog>
</div>

<!-- Modal de Sucesso Personalizado -->
<div *ngIf="showSuccessModal" class="fixed inset-0 bg-black bg-opacity-60 z-[9999] flex items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden transform transition-all">
    <!-- Header compacto sem Ã­cone -->
    <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-2 text-center text-white">
      <h2 class="text-lg font-bold">Upload Realizado!</h2>
      <p class="text-green-100 text-sm">Arquivo enviado com sucesso</p>
    </div>

    <!-- ConteÃºdo -->
    <div class="px-6 py-4">
      <!-- InformaÃ§Ãµes em grid horizontal -->
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div class="text-center">
          <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-2">
            <mat-icon class="text-blue-600 text-lg">description</mat-icon>
          </div>
          <p class="text-xs text-gray-500">Arquivo</p>
          <p class="font-semibold text-sm text-gray-800 truncate">{{ successModalData.fileName }}</p>
        </div>

        <div class="text-center">
          <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mx-auto mb-2">
            <mat-icon class="text-purple-600 text-lg">location_city</mat-icon>
          </div>
          <p class="text-xs text-gray-500">MunicÃ­pio</p>
          <p class="font-semibold text-sm text-gray-800 truncate">{{ successModalData.municipalityName }}</p>
        </div>

        <div class="text-center">
          <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mx-auto mb-2">
            <mat-icon class="text-orange-600 text-lg">{{ uploadType === 'servidores' ? 'business' : 'account_balance'
              }}</mat-icon>
          </div>
          <p class="text-xs text-gray-500">{{ uploadType === 'servidores' ? 'Servidor' : 'Tipo de Documento' }}</p>
          <p class="font-semibold text-sm text-gray-800 truncate">{{ successModalData.serverName }}</p>
        </div>
      </div>

      <!-- Pasta hierÃ¡rquica compacta -->
      <div class="p-3 bg-gray-50 rounded-lg">
        <p class="text-xs text-gray-600 mb-1">ðŸ“‚ LocalizaÃ§Ã£o:</p>
        <p class="text-xs font-mono text-gray-800 truncate" *ngIf="uploadType === 'servidores'">
          {{ successModalData.municipalityName }} > Servidores {{ successModalData.serverName.charAt(0).toUpperCase() }}
          > {{ successModalData.serverName }}
        </p>
        <p class="text-xs font-mono text-gray-800 truncate" *ngIf="uploadType === 'financeiras'">
          {{ successModalData.municipalityName }} > DocumentaÃ§Ãµes Financeiras > {{ successModalData.serverName }}
        </p>
      </div>
    </div>

    <!-- AÃ§Ãµes -->
    <div class="px-6 pb-4">
      <button (click)="closeSuccessModal()"
        class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:from-green-600 hover:to-green-700 transition-all duration-200 flex items-center justify-center gap-2 text-sm">
        <mat-icon class="text-lg">check</mat-icon>
        Continuar
      </button>
    </div>
  </div>
</div>

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-white p-6">
  <div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-8">
      <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
        <mat-icon class="text-blue-600">cloud_upload</mat-icon>
      </div>
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Upload de Documentos</h1>
        <p class="text-gray-600">Envie documentos para o Google Drive organizados por municÃ­pio</p>
      </div>
    </div>

    <!-- FormulÃ¡rio com Toggle -->
    <div class="bg-white rounded-xl shadow-lg p-8 relative z-10">
      <!-- Toggle de Tipo de Upload -->
      <!-- Toggle de Tipo de Upload -->
      <div class="radio-toggle-section w-full mb-8 pb-8 border-b border-gray-200">
        <div class="flex flex-col md:flex-row items-stretch md:items-center justify-center gap-4 md:gap-8">

          <!-- OpÃ§Ã£o Servidores -->
          <label
            class="relative flex items-center p-4 rounded-xl border-2 cursor-pointer transition-all duration-200 group hover:shadow-md"
            [class.border-blue-500]="uploadType === 'servidores'" [class.bg-blue-50]="uploadType === 'servidores'"
            [class.border-gray-200]="uploadType !== 'servidores'">
            <input type="radio" [(ngModel)]="uploadType" value="servidores" name="uploadType"
              class="absolute opacity-0 w-0 h-0">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full flex items-center justify-center transition-colors"
                [class.bg-blue-100]="uploadType === 'servidores'" [class.bg-gray-100]="uploadType !== 'servidores'">
                <mat-icon [class.text-blue-600]="uploadType === 'servidores'" class="text-gray-500">people</mat-icon>
              </div>
              <span class="text-lg font-medium transition-colors" [class.text-blue-800]="uploadType === 'servidores'"
                [class.text-gray-600]="uploadType !== 'servidores'">
                Servidores
              </span>
            </div>
            <div *ngIf="uploadType === 'servidores'" class="absolute right-4 text-blue-500">
              <mat-icon>check_circle</mat-icon>
            </div>
          </label>

          <!-- OpÃ§Ã£o DocumentaÃ§Ãµes Financeiras -->
          <label
            class="relative flex items-center p-4 rounded-xl border-2 cursor-pointer transition-all duration-200 group hover:shadow-md"
            [class.border-green-500]="uploadType === 'financeiras'" [class.bg-green-50]="uploadType === 'financeiras'"
            [class.border-gray-200]="uploadType !== 'financeiras'">
            <input type="radio" [(ngModel)]="uploadType" value="financeiras" name="uploadType"
              class="absolute opacity-0 w-0 h-0">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full flex items-center justify-center transition-colors"
                [class.bg-green-100]="uploadType === 'financeiras'" [class.bg-gray-100]="uploadType !== 'financeiras'">
                <mat-icon [class.text-green-600]="uploadType === 'financeiras'"
                  class="text-gray-500">account_balance</mat-icon>
              </div>
              <span class="text-lg font-medium transition-colors" [class.text-green-800]="uploadType === 'financeiras'"
                [class.text-gray-600]="uploadType !== 'financeiras'">
                DocumentaÃ§Ãµes Financeiras
              </span>
            </div>
            <div *ngIf="uploadType === 'financeiras'" class="absolute right-4 text-green-500">
              <mat-icon>check_circle</mat-icon>
            </div>
          </label>

        </div>
      </div>
      <form [formGroup]="uploadForm" class="space-y-8">

        <!-- SEÃ‡ÃƒO 1: CONTEXTO (Card Cinza Claro) -->
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="text-gray-800 font-bold mb-4 flex items-center gap-2">
            <mat-icon class="text-blue-600">domain</mat-icon>
            {{ uploadType === 'servidores' ? 'SeleÃ§Ã£o de Servidor' : 'SeleÃ§Ã£o de Categoria Financeira' }}
          </h3>

          <div class="space-y-4">
            <!-- SERVIDORES -->
            <div *ngIf="uploadType === 'servidores'" class="space-y-4">
              <!-- MunicÃ­pio -->
              <div class="grid grid-cols-1 md:grid-cols-[1fr,auto] gap-4 items-end">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">MunicÃ­pio *</label>
                  <select formControlName="municipality_code" required (change)="onMunicipalityChange($event)"
                    class="w-full h-11 border border-gray-300 rounded-lg px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                    <option value="" disabled>Selecione um municÃ­pio</option>
                    <option *ngFor="let municipality of municipalities" [value]="municipality.code">
                      {{municipality.name}} - {{municipality.state}}
                    </option>
                  </select>
                </div>
                <button type="button" (click)="openMunicipalityDialog()"
                  class="h-11 px-4 bg-white border border-blue-200 text-blue-700 hover:bg-blue-50 font-medium rounded-lg flex items-center justify-center gap-2 transition-colors whitespace-nowrap shadow-sm">
                  <mat-icon class="text-base leading-none w-4 h-4">add</mat-icon>
                  Novo MunicÃ­pio
                </button>
              </div>

              <!-- Servidor -->
              <div class="grid grid-cols-1 md:grid-cols-[1fr,auto] gap-4 items-end">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Servidor *</label>
                  <select formControlName="server_id" required
                    class="w-full h-11 border border-gray-300 rounded-lg px-3 text-base focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white">
                    <option value="" disabled>Selecione um servidor</option>
                    <option *ngFor="let server of servers" [value]="server.id">
                      {{server.name}}
                    </option>
                  </select>
                </div>
                <button type="button" (click)="openServerDialog()" [disabled]="!selectedMunicipalityCode"
                  class="h-11 px-4 bg-white border border-green-200 text-green-700 hover:bg-green-50 font-medium disabled:bg-gray-100 disabled:text-gray-400 disabled:border-gray-200 rounded-lg flex items-center justify-center gap-2 transition-colors whitespace-nowrap shadow-sm">
                  <mat-icon class="text-base leading-none w-4 h-4">person_add</mat-icon>
                  Novo Servidor
                </button>
              </div>

              <!-- Estrutura HierÃ¡rquica no Google Drive -->
              <div *ngIf="canShowHierarchicalPath()" class="mt-4 bg-blue-50/50 border border-blue-100 p-3 rounded-lg">
                <div class="flex items-start gap-3">
                  <mat-icon class="text-blue-500 text-sm mt-0.5">folder</mat-icon>
                  <div class="text-sm">
                    <p class="text-gray-500 text-xs uppercase font-semibold mb-1">Caminho no Drive</p>
                    <p class="text-blue-800 font-mono">{{getHierarchicalPath()}}</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- FINANCEIRAS -->
            <div *ngIf="uploadType === 'financeiras'" class="space-y-4">
              <!-- MunicÃ­pio -->
              <div class="grid grid-cols-1 md:grid-cols-[1fr,auto] gap-4 items-end">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">MunicÃ­pio *</label>
                  <select formControlName="municipality_code" required (change)="onMunicipalityChange($event)"
                    class="w-full h-11 border border-gray-300 rounded-lg px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                    <option value="" disabled>Selecione um municÃ­pio</option>
                    <option *ngFor="let municipality of municipalities" [value]="municipality.code">
                      {{municipality.name}} - {{municipality.state}}
                    </option>
                  </select>
                </div>
                <button type="button" (click)="openMunicipalityDialog()"
                  class="h-11 px-4 bg-white border border-blue-200 text-blue-700 hover:bg-blue-50 font-medium rounded-lg flex items-center justify-center gap-2 transition-colors whitespace-nowrap shadow-sm">
                  <mat-icon class="text-base leading-none w-4 h-4">add</mat-icon>
                  Novo MunicÃ­pio
                </button>
              </div>

              <!-- Tipo de Documento -->
              <div class="grid grid-cols-1 md:grid-cols-[1fr,auto] gap-4 items-end">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Documento *</label>
                  <select formControlName="financial_document_type" required
                    class="w-full h-11 border border-gray-300 rounded-lg px-3 text-base focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white">
                    <option value="" disabled>Selecione o tipo</option>
                    <option *ngFor="let type of financialDocumentTypes" [value]="type.code">
                      {{type.name}}
                    </option>
                  </select>
                </div>
                <button type="button" (click)="openFinancialTypeDialog()"
                  class="h-11 px-4 bg-white border border-green-200 text-green-700 hover:bg-green-50 font-medium rounded-lg flex items-center justify-center gap-2 transition-colors whitespace-nowrap shadow-sm">
                  <mat-icon class="text-base leading-none w-4 h-4">post_add</mat-icon>
                  Novo Tipo
                </button>
              </div>

              <!-- Ano e PerÃ­odo -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Ano *</label>
                  <select formControlName="financial_year" required
                    class="w-full h-11 border border-gray-300 rounded-lg px-3 text-base focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white">
                    <option value="" disabled>Selecione</option>
                    <option *ngFor="let year of getAvailableYears()" [value]="year">{{year}}</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">PerÃ­odo (Opcional)</label>
                  <select formControlName="financial_period"
                    class="w-full h-11 border border-gray-300 rounded-lg px-3 text-base focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white">
                    <option value="">Anual</option>
                    <option value="1">1Âº Trimestre</option>
                    <option value="2">2Âº Trimestre</option>
                    <option value="3">3Âº Trimestre</option>
                    <option value="4">4Âº Trimestre</option>
                    <option value="semestral-1">1Âº Semestre</option>
                    <option value="semestral-2">2Âº Semestre</option>
                  </select>
                </div>
              </div>

              <!-- Caminho Financeiro -->
              <div *ngIf="canShowFinancialPath()" class="mt-4 bg-green-50/50 border border-green-100 p-3 rounded-lg">
                <div class="flex items-start gap-3">
                  <mat-icon class="text-green-500 text-sm mt-0.5">folder</mat-icon>
                  <div class="text-sm">
                    <p class="text-gray-500 text-xs uppercase font-semibold mb-1">Caminho no Drive</p>
                    <p class="text-green-800 font-mono">{{getFinancialPath()}}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SEÃ‡ÃƒO 2: DETALHES DO DOCUMENTO -->
        <div>
          <h3 class="text-gray-800 font-bold mb-4 flex items-center gap-2">
            <mat-icon class="text-gray-600">description</mat-icon>
            Detalhes do Documento
          </h3>

          <div class="space-y-4">
            <!-- TÃ­tulo -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">TÃ­tulo do Documento *</label>
              <input formControlName="title" required placeholder="Ex: Contrato 2024"
                class="w-full h-11 border border-gray-300 rounded-lg px-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow">
            </div>

            <!-- DescriÃ§Ã£o -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">DescriÃ§Ã£o (Opcional)</label>
              <textarea formControlName="description" rows="3" placeholder="InformaÃ§Ãµes adicionais sobre o documento..."
                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-shadow"></textarea>
            </div>
          </div>
        </div>

        <!-- SEÃ‡ÃƒO 3: ARQUIVO (Dropzone) -->
        <div>
          <div
            class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50/30 transition-all duration-200 group"
            [class.border-blue-500]="isDragOver" [class.bg-blue-50]="isDragOver" (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)" (drop)="onFileDrop($event)" (click)="fileInput.click()">

            <input #fileInput type="file" (change)="onFileSelected($event)"
              accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.txt" class="hidden">

            <div *ngIf="!selectedFile" class="flex flex-col items-center justify-center">
              <div
                class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-200">
                <mat-icon class="text-blue-600 text-3xl">cloud_upload</mat-icon>
              </div>
              <h3 class="text-lg font-bold text-gray-700 mb-1">Clique para selecionar ou arraste aqui</h3>
              <p class="text-sm text-gray-500 mb-4">Suporta PDF, Word, Excel, Images (Max 500MB)</p>
              <button type="button"
                class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg text-sm shadow-sm hover:bg-gray-50">
                Selecionar Arquivo
              </button>
            </div>

            <div *ngIf="selectedFile"
              class="flex items-center gap-4 bg-white border border-blue-100 rounded-xl p-4 shadow-sm text-left relative overflow-hidden">
              <div class="absolute inset-y-0 left-0 w-1 bg-blue-500"></div>
              <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center flex-shrink-0">
                <mat-icon class="text-blue-600">{{getFileIcon(selectedFile.type)}}</mat-icon>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-bold text-gray-800 truncate">{{selectedFile.name}}</h4>
                <p class="text-xs text-gray-500 font-mono">{{formatFileSize(selectedFile.size)}}</p>
              </div>
              <button mat-icon-button color="warn" (click)="removeFile($event)" type="button"
                class="hover:bg-red-50 rounded-full transition-colors">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>

          <!-- Barra de Progresso -->
          <div *ngIf="uploadProgress > 0" class="mt-4">
            <div class="flex justify-between text-xs text-gray-600 mb-1">
              <span>{{isLargeFile ? 'Compactando e enviando...' : 'Enviando...'}}</span>
              <span>{{uploadProgress}}%</span>
            </div>
            <mat-progress-bar mode="determinate" [value]="uploadProgress" class="rounded-full h-2"></mat-progress-bar>
            <p *ngIf="isLargeFile" class="text-xs text-blue-600 mt-1">
              Arquivo grande detectado - compactando para otimizar visualizaÃ§Ã£o
            </p>
          </div>
        </div>

        <!-- BotÃµes de AÃ§Ã£o -->
        <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-100">
          <button type="button" (click)="resetForm()" [disabled]="isUploading"
            class="px-6 py-2.5 text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors">
            Limpar
          </button>

          <button type="button" [disabled]="isSubmitDisabled()" (click)="mainButtonClick($event)"
            class="px-8 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:shadow-none flex items-center gap-2">
            <mat-spinner *ngIf="isUploading" diameter="20" class="brightness-0 invert"></mat-spinner>
            <span>{{isUploading ? (isLargeFile ? 'Compactando...' : 'Enviando...') : 'Enviar Documento'}}</span>
            <mat-icon *ngIf="!isUploading" class="ml-1">send</mat-icon>
          </button>
        </div>
      </form>
      <!-- Lista de documentos recentes -->
      <div *ngIf="recentDocuments.length > 0" class="mt-8 bg-gray-50 rounded-xl p-6">
        <h2 class="text-lg font-bold text-gray-700 mb-4">Documentos Recentes</h2>
        <div class="space-y-3">
          <div *ngFor="let doc of recentDocuments"
            class="flex items-center gap-4 p-4 bg-white rounded-lg hover:shadow-md transition-shadow cursor-pointer"
            (click)="viewDocument(doc)">
            <mat-icon class="text-blue-500 text-2xl">{{getFileIcon(doc.mime_type)}}</mat-icon>
            <div class="flex-1">
              <h4 class="font-medium text-gray-800">{{doc.title}}</h4>
              <p class="text-sm text-gray-500">{{doc.file_name}} â€¢ {{formatFileSize(doc.file_size)}}</p>
              <small class="text-xs text-gray-400">{{formatDate(doc.created_at)}}</small>
            </div>
            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
              <button mat-icon-button (click)="downloadDocument(doc, $event)">
                <mat-icon>download</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteDocument(doc, $event)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>